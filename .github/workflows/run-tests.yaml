name: tests

on:
  push:
    branches:
      - main
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"
      - "[0-9]+.[0-9]+.[0-9]+-*"
    paths-ignore:
      - .reuse
      - LICENSES/
      - LICENSE
      - .gitignore
      - "**.md"

  pull_request_target:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - .reuse
      - LICENSES/
      - LICENSE
      - .gitignore
      - "**.md"
env:
  GITHUB_BASELINE_WORKFLOW_REF: "tests"

permissions:
  contents: read
  
jobs:
# lint:
############################################################################################
  unit-tests:
    runs-on: ubuntu-latest
    steps:
############################################################################################
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        ref: ${{ github.event.pull_request.head.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name }}
############################################################################################
    - name: Set up cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
          /home/runner/work/infrastructure-manager/infrastructure-manager/bin
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
############################################################################################
    - name: Set up go environment
      uses: actions/setup-go@v5
      with:
        go-version: 1.25.1
############################################################################################
    - name: Run unit tests
      run: make test
    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      if: success() || failure()
      with:
        name: "code-coverage"
        path: "coverage.txt"
    - name: filter out coverage
      run: |
        #!/bin/bash

        filters=(
            "mock"
            "test"
            "github.com/kyma-project/infrastructure-manager/api"
        )

        input="./coverage.txt"
        output="./coverage-filtered.txt"

        cp "$input" "$output"

        for i in "${filters[@]}"; do
          echo "filtering $i"
          cp "$output" "$output~"
          grep --invert-match $i "$output~" > "$output"
          wc -l $output
        done
        rm "$output~"

    - name: coveralls github action
      uses: coverallsapp/github-action@v2.3.6
      with:
        format: golang
        file: ./coverage-filtered.txt
        fail-on-error: false

  code_coverage:
    name: "Code coverage report"
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    needs: unit-tests
    permissions:
      contents: read
      actions: read
      pull-requests: write
    steps:
      - uses: fgrosse/go-coverage-report@ae3204f4125161ae4a75780bdb57dec472bfd49c
        with:
          coverage-artifact-name: "code-coverage"
          coverage-file-name: "coverage.txt"
